# 玲珑OS安全与权限

## 1. 整体安全架构

玲珑OS的安防体系构建于“纵深防御”和“最小权限”两大核心原则之上，旨在通过多层次、全方位的安全策略，确保系统、用户及数据的完整性与机密性。

### 1.1 信任分层
我们将系统中的实体划分为不同的信任等级，由内到外依次为：
- **T0 (最高信任)**: 玲珑OS内核与核心服务，拥有系统最高权限。
- **T1 (高信任)**: 官方出品的核心应用插件，经过严格审查，权限受控。
- **T2 (中等信任)**: 经过认证的第三方应用插件，权限受限，运行于沙箱环境。
- **T3 (低信任)**: 未经认证的第三方应用或脚本，权限极低，运行于最严格的沙箱环境。

### 1.2 安全边界
在不同信任等级的实体之间，我们设立了清晰的安全边界，并通过多种技术手段强制执行隔离策略。
- **进程/线程隔离**: 后端服务采用多进程模型，前端利用`Worker`线程隔离计算密集型任务。
- **沙箱隔离**: 前端通过`iframe`为第三方UI应用提供独立的运行环境，严格限制其DOM访问和API调用能力。
- **API网关**: 作为所有内外通信的必经之路，API网关负责认证、授权、校验和限流，是保护后端服务的核心屏障。

## 2. 用户认证 (Authentication)

统一鉴权模块为整个玲珑OS提供身份认证服务，其设计目标是安全、可靠且易于扩展。

### 2.1 认证流程
1. **用户登录**: 用户通过账号密码进行首次登录。
2. **密码验证**: 后端使用`bcrypt`对存储的密码哈希进行比对，有效防止彩虹表攻击。
3. **双因素认证 (2FA)**: 如果用户启用了2FA，系统会要求输入基于时间的一次性密码（TOTP），通过`speakeasy`库进行验证。
4. **令牌生成**: 验证成功后，系统将生成JWT格式的`accessToken`和`refreshToken`。
5. **访问控制**: 用户后续请求需在HTTP头中携带`accessToken`，由认证中间件进行验证。

### 2.2 核心安全特性
- **防暴力破解**: 记录登录失败次数，在达到阈值后临时锁定账户。
- **安全的令牌刷新**: `refreshToken`用于获取新的`accessToken`，自身拥有较长有效期并可被吊销，增强了会话安全性。
- **2FA支持**: 提供TOTP双因素认证，包括密钥生成、二维码展示、备份码等全套功能。
- **详细的登录日志**: 记录所有成功和失败的登录尝试，便于审计和异常检测。

## 3. 授权与权限控制 (Authorization)

授权机制确保用户和插件只能访问其被允许访问的资源。

### 3.1 基于角色的访问控制 (RBAC)
- **角色定义**: 系统预设多种角色（如`admin`, `developer`, `user`），并支持自定义角色。
- **权限绑定**: 每个角色可以绑定一组权限（如`plugin:install`, `user:manage`）。
- **用户分配**: 用户可以被赋予一个或多个角色。

### 3.2 插件权限
- **清单声明 (Manifest)**: 插件必须在其`manifest.json`中明确声明所需的权限列表。
- **用户授权**: 用户在安装或更新插件时，会被明确告知插件申请的权限，并需要手动确认授权。
- **运行时检查**: 当插件通过SDK调用敏感API时，SDK和后端会再次校验该插件是否已被授予相应权限。

## 4. 数据安全

### 4.1 传输安全
- **HTTPS**: 所有客户端与服务器之间的通信强制使用HTTPS加密。

### 4.2 存储安全
- **密码哈希**: 用户密码使用`bcrypt`进行单向哈希加密存储。
- **敏感数据加密**: 对于数据库中存储的其他敏感信息（如第三方服务密钥），将进行对称或非对称加密。

### 4.3 防护措施
- **SQL注入防护**: 使用ORM（Sequelize）和参数化查询，从根本上杜绝SQL注入风险。
- **跨站脚本 (XSS) 防护**: 对所有用户输入进行严格的过滤和转义；前端框架（React）本身也提供了强大的XSS防护能力。
- **跨站请求伪造 (CSRF) 防护**: Egg.js框架内置了CSRF令牌机制，可有效抵御CSRF攻击。

---

## 5. 文档元数据

- **文档类型**: 安全与权限设计文档
- **关键词**: 安全, 权限, 认证, 授权, RBAC, JWT, 2FA, 沙箱, 数据安全, XSS, CSRF
- **目标读者**: 安全工程师, 架构师, 核心开发者
- **核心内容**: 本文档全面阐述了玲珑OS的安全架构、用户认证机制、授权与权限控制模型（RBAC），以及数据安全（传输、存储、防护）的最佳实践。
- **AI解析优化**:
  - 明确定义了“信任分层”和“安全边界”等核心安全概念。
  - 详细描述了用户认证（含2FA）和令牌刷新的流程。
  - 对RBAC和插件权限声明机制有清晰的解释。
  - 列举了常见的Web安全威胁（SQL注入, XSS, CSRF）及其防护措施。