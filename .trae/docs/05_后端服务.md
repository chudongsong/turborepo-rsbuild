# 玲珑OS后端服务

## 1. 后端架构

### 1.1 技术栈
- **框架**: Egg.js
- **数据库**: SQLite (开发环境), PostgreSQL (生产环境)
- **ORM**: Sequelize
- **缓存**: Redis
- **任务队列**: Bull

### 1.2 服务划分
后端服务采用微服务思想进行划分，但初期会以一个单体应用的形式存在，通过Egg.js的插件机制来组织不同的服务模块。
- **API Gateway**: 所有客户端请求的统一入口。
- **Plugin Registry**: 管理插件的元数据和版本。
- **Authentication Service**: 负责用户认证和授权。
- **File Service**: 提供文件存储和管理功能。
- **Data Service**: 提供通用的数据存储服务。

## 2. API网关

### 2.1 职责
- **路由转发**: 根据请求路径将请求转发到内部的相应服务。
- **认证与授权**: 对所有传入的请求进行身份验证和权限检查。
- **请求校验**: 校验请求参数的合法性。
- **限流与熔断**: 防止恶意请求和后端服务过载。
- **日志记录**: 记录所有API请求和响应的详细日志。

### 2.2 实现
- 使用Egg.js的中间件机制来实现上述功能。
- 路由配置在`app/router.js`中统一定义。

## 3. 插件注册中心 (Plugin Registry)

### 3.1 数据库模型
```sql
CREATE TABLE plugins (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  name VARCHAR(255) NOT NULL UNIQUE,
  description TEXT,
  author VARCHAR(255),
  repository_url VARCHAR(255)
);

CREATE TABLE plugin_versions (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  plugin_id INTEGER NOT NULL,
  version VARCHAR(255) NOT NULL,
  manifest TEXT NOT NULL, -- 存储JSON格式的manifest
  package_url VARCHAR(255) NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (plugin_id) REFERENCES plugins(id)
);
```

### 3.2 API接口

#### 3.2.1 获取插件列表
- **Endpoint**: `GET /api/v1/plugins`
- **描述**: 获取所有已发布的插件列表。
- **请求参数**: 无
- **响应示例**:
  ```json
  {
    "code": 0,
    "message": "Success",
    "data": [
      {
        "name": "file-explorer",
        "description": "A file explorer plugin.",
        "author": "LinglongOS Team",
        "latest_version": "1.0.0"
      }
    ]
  }
  ```

#### 3.2.2 获取插件详情
- **Endpoint**: `GET /api/v1/plugins/:name`
- **描述**: 获取单个插件的详细信息，包括所有版本。
- **请求参数**:
  - `name` (path, string, required): 插件名称。
- **响应示例**:
  ```json
  {
    "code": 0,
    "message": "Success",
    "data": {
      "name": "file-explorer",
      "description": "A file explorer plugin.",
      "author": "LinglongOS Team",
      "versions": [
        {
          "version": "1.0.0",
          "manifest_url": "/api/v1/plugins/file-explorer/1.0.0/manifest.json",
          "package_url": "/api/v1/plugins/file-explorer/1.0.0/package.zip"
        }
      ]
    }
  }
  ```

#### 3.2.3 发布新插件
- **Endpoint**: `POST /api/v1/plugins`
- **描述**: (管理员权限) 发布一个新插件或新版本。
- **请求体**: `multipart/form-data`
  - `manifest` (file, required): `manifest.json`文件。
  - `package` (file, required): 插件代码包。
- **响应示例**:
  ```json
  {
    "code": 0,
    "message": "Plugin published successfully.",
    "data": null
  }
  ```

## 4. 认证服务 (Authentication Service)

### 4.1 认证流程
采用基于JWT (JSON Web Token) 的认证机制。
1. 用户通过用户名和密码登录。
2. 服务端验证通过后，生成一个包含用户信息的JWT，并返回给客户端。
3. 客户端在后续请求的`Authorization`头中携带此JWT。
4. API网关统一对JWT进行验证。

### 4.2 API接口

#### 4.2.1 用户登录
- **Endpoint**: `POST /api/v1/auth/login`
- **请求体**: `application/json`
  ```json
  {
    "username": "admin",
    "password": "password123"
  }
  ```
- **响应示例**:
  ```json
  {
    "code": 0,
    "message": "Login successful.",
    "data": {
      "token": "ey...",
      "expires_in": 7200
    }
  }
  ```

## 5. 文件服务 (File Service)

### 5.1 存储策略
- **本地存储**: 开发环境下，文件直接存储在服务器本地磁盘。
- **对象存储**: 生产环境下，建议使用云厂商的对象存储服务（如AWS S3, 阿里云OSS），以获得更好的扩展性和可靠性。

### 5.2 API接口

#### 5.2.1 上传文件
- **Endpoint**: `POST /api/v1/files/upload`
- **请求体**: `multipart/form-data`
  - `file` (file, required): 要上传的文件。
  - `path` (string, optional): 上传路径。
- **响应示例**:
  ```json
  {
    "code": 0,
    "message": "File uploaded successfully.",
    "data": {
      "url": "/uploads/mydir/myfile.txt"
    }
  }
  ```

---

## 6. 文档元数据

- **文档类型**: 后端服务文档
- **关键词**: 后端, Egg.js, API网关, 插件注册中心, 认证服务, 文件服务, 数据库模型, RESTful API
- **目标读者**: 后端开发者, 架构师
- **核心内容**: 本文档详细描述了玲珑OS后端服务的架构、技术栈、核心服务模块（如插件注册、认证、文件服务）的设计与API接口。
- **AI解析优化**:
  - 提供了清晰的SQL数据库模型定义。
  - 对每个API接口提供了详细的Endpoint、请求/响应格式和JSON示例，便于AI解析和生成客户端代码。
  - 明确了技术栈和各服务模块的职责。