# Linglong Desktop 应用（React + TypeScript + rsbuild）

本文档详细描述了 Linglong Desktop 核心应用的完整功能架构、技术实现方案与未来规划，旨在为开发团队提供清晰、全面的参考。

## 1. 整体架构设计

Linglong Desktop 采用基于 React 的现代化前端架构，通过 Redux Toolkit 实现中心化状态管理，并结合 `react-dnd` 提供丰富的拖拽交互。整体架构遵循模块化、可扩展的设计原则。

### 1.1. 架构设计图

```
+-------------------------------------------------------------------+
|                           Linglong Desktop                        |
|-------------------------------------------------------------------|
|      UI Layer (React Components, Tailwind CSS, react-dnd)         |
|-------------------------------------------------------------------|
|      +-----------------+ +-----------------+ +-----------------+  |
|      | Desktop Module  | | Window Manager  | | Status Bar      |  |
|      +-----------------+ +-----------------+ +-----------------+  |
|      +-----------------+ +-----------------+                      |
|      | Context Menu    | | Plugin System   |                      |
|      +-----------------+ +-----------------+                      |
|-------------------------------------------------------------------|
|      State Management Layer (Redux Toolkit)                       |
|      +-----------------+ +-----------------+ +-----------------+  |
|      |  desktopSlice   | |  windowSlice    | | settingsSlice   |  |
|      +-----------------+ +-----------------+ +-----------------+  |
|-------------------------------------------------------------------|
|      Service & Logic Layer                                        |
|      +-----------------+ +-----------------+ +-----------------+  |
|      |  PluginService  | |   ApiService    | |   Hook Logic    |  |
|      +-----------------+ +-----------------+ +-----------------+  |
+-------------------------------------------------------------------+
```

### 1.2. 技术栈

- **核心框架**: `React 19` + `TypeScript`
- **构建工具**: `rsbuild`
- **状态管理**: `Redux Toolkit`
- **拖拽交互**: `react-dnd`
- **样式方案**: `tailwindcss`
- **测试工具**: `rstest` + `React Testing Library`

---

## 2. 核心模块详解

### 2.1. 桌面功能 (Desktop)

桌面是核心交互区域，负责应用图标、小组件的渲染与管理。

#### 功能描述

- **图标应用显示**:
  - 支持应用图标的网格化自动排列。
  - 通过 `react-dnd` 实现图标的自由拖拽排序。
  - 支持创建文件夹对应用进行分组管理。
  - 允许用户自定义图标显示大小、字体样式。
- **自定义小组件**:
  - 实现了一个可拖拽、可调整大小的小组件系统。
  - 支持时钟、天气、系统监控等多种数据展示形式。
  - 小组件配置持久化，支持用户自定义布局。

#### 实现原理

- **网格系统**: `Desktop.tsx` 组件在加载时动态计算屏幕尺寸，生成虚拟网格。图标和组件的位置基于网格坐标进行吸附对齐，相关计算逻辑封装在 `hooks/useGrid.ts` 中。
- **拖拽与状态同步**: 利用 `react-dnd` 的 `useDrag` 和 `useDrop` Hooks，在拖拽结束时，通过 Redux Action (`desktopSlice`) 更新图标或小组件的位置信息，触发组件重渲染。
- **配置持久化**: 用户对桌面布局、图标和组件的配置存储在 Redux Store 中，并通过 `ApiService` 与后端同步，实现云端保存。

---

### 2.2. 状态栏功能 (Status Bar)

状态栏位于屏幕顶部，提供系统核心信息展示与快捷操作。

#### 功能描述

- **Dark 模式支持**:
  - 提供一键切换 Dark/Light 模式的按钮。
  - 状态栏、窗口及所有内置应用的 UI 均支持主题切换。
- **状态信息展示**:
  - **系统时间**: 实时显示当前时间。
  - **网络状态**: 显示 Wi-Fi 或以太网连接状态。
  - **电量信息**: 显示电池剩余电量及充电状态。
  - **通知中心**: 聚合系统和应用的通知。

#### 实现原理

- **主题切换**: 使用 `tailwindcss` 的 `dark:` 变体实现。全局主题状态（`'dark' | 'light'`）存储在 `settingsSlice` 中。切换时，在 `<html>` 根元素上添加或移除 `dark` 类，触发全局样式变更。
- **状态获取**:
  - **时间**: 通过 `setInterval` 定时更新。
  - **网络/电量**: 通过调用 Electron 或 `Tauri` 暴露的系统 API 获取，并通过 `ApiService` 轮询更新到 `settingsSlice`。

---

### 2.3. 窗口管理 (Window Manager)

`WindowManager` 是一个核心组件，负责所有应用窗口的创建、渲染和生命周期管理。

#### 功能描述

- **窗口创建/销毁**:
  - 点击应用图标时，创建新窗口。
  - 关闭窗口时，从视图中移除并清理相关状态。
- **窗口层级管理**:
  - 点击窗口时，自动将其置于顶层（z-index 最高）。
  - 支持窗口聚焦、失焦状态的视觉反馈。
- **窗口操作**:
  - **最小化**: 将窗口隐藏到 Dock 栏，保留其状态。
  - **最大化**: 使窗口占据整个桌面可用空间。
  - **关闭**: 销毁窗口实例。
  - **拖拽与缩放**: 支持自由拖动窗口位置和调整窗口大小。

#### 实现原理

- **窗口状态模型**: `windowSlice` 负责管理所有窗口的状态，包括 `id`, `appId`, `position`, `size`, `zIndex`, `isMinimized`, `isMaximized`, `isFocused` 等。
- **生命周期管理**:
  - **创建**: `dispatch(createWindow({ appId, ... }))` -> 在 `windowSlice` 中新增一个窗口对象。`WindowManager` 组件根据 state 渲染出新窗口。
  - **聚焦**: 点击窗口时，`dispatch(focusWindow({ windowId }))` -> 重新计算所有窗口的 `zIndex`，确保目标窗口层级最高。
  - **关闭**: `dispatch(closeWindow({ windowId }))` -> 从 `windowSlice` 中移除对应窗口对象。
- **渲染**: `WindowManager.tsx` 订阅 `windowSlice` 的状态，通过 `map` 遍历所有窗口对象，并渲染出对应的窗口组件。每个窗口的位置和尺寸由其 state 决定。

---

### 2.4. 右键菜单 (Context Menu)

提供上下文敏感的右键菜单功能，提升操作效率。

#### 功能描述

- **上下文敏感**:
  - 在桌面空白处右键，显示“新建文件夹”、“更换壁纸”等选项。
  - 在应用图标上右键，显示“打开”、“卸载”等选项。
- **动态加载**: 菜单项根据当前状态（如文件类型、权限）动态生成。
- **快捷键支持**: 关键菜单项旁边显示对应的快捷键提示。

#### 实现原理

- **全局事件监听**: 在应用根组件 `App.tsx` 中监听 `contextmenu` 事件。
- **上下文判断**: 事件处理函数根据 `event.target` 判断右键点击的上下文（如桌面、图标、窗口标题栏），并从 `menuConfig` 中获取对应的菜单结构。
- **动态渲染**: 右键菜单是一个全局单例组件，根据传入的菜单结构和位置信息动态渲染。菜单项的 `onClick` 回调直接 `dispatch` Redux Action 或调用 `ApiService`。

---

### 2.5. 插件系统 (Plugin System)

提供一个轻量级的插件系统，允许第三方开发者扩展桌面功能。

#### 功能描述

- **插件注册/注销**:
  - 应用启动时，从指定目录加载插件。
  - 支持动态安装（注册）和卸载（注销）插件。
- **插件生命周期**:
  - `onLoad`: 插件加载时触发，用于初始化。
  - `onUnload`: 插件卸载时触发，用于清理资源。
- **插件 API**:
  - 提供一组稳定的 API 接口，允许插件：
    - 注册新的小组件。
    - 添加状态栏图标。
    - 注册全局快捷键。
    - 调用系统通知。

#### 实现原理

- **插件管理器 (`PluginService`)**: 负责插件的加载、生命周期管理和 API 注入。
- **注册流程**:
  1. 启动时，`PluginService` 扫描 `plugins` 目录。
  2. 对每个插件，执行其 `main.js` 文件，并调用其 `onLoad` 方法。
  3. `onLoad` 方法接收一个 `api` 对象，插件通过该对象调用 `api.registerWidget`, `api.registerStatusIcon` 等方法注册其功能。
- **API 接口规范**: `PluginService` 定义了严格的 API 接口规范和 TypeScript 类型，确保插件与主应用之间的交互是类型安全的。

---

## 3. 性能与扩展

### 3.1. 性能优化指标

- **启动性能**: 首次加载时间 < 2s。通过 `rsbuild` 的代码分割和摇树优化实现。
- **渲染性能**:
  - 拖拽操作期间，CPU 使用率 < 20%。通过 `React.memo` 和 `useCallback` 避免不必要的重渲染。
  - 对于大量图标或组件，采用虚拟滚动技术，只渲染视口内的元素。
- **内存占用**: 空闲状态下，内存占用 < 100MB。及时清理已销毁窗口的关联状态。

### 3.2. 兼容性要求

- **操作系统**: macOS, Windows, Linux（通过 Electron 或 Tauri 打包）。
- **浏览器环境**: Chrome, Firefox, Safari 最新版本。

### 3.3. 未来扩展规划

- **多屏支持**: 优化窗口和桌面在多显示器环境下的表现。
- **高级插件 API**: 开放更多系统级 API 给插件，如文件系统访问、网络请求等。
- **动画与过渡效果**: 引入更流畅的窗口和 UI 动画效果，提升用户体验。
- **WebAssembly 集成**: 将性能敏感的计算（如图像处理）迁移到 WebAssembly 中执行。
