# 端口检测工具使用说明

本文档介绍了 LinglongOS API 服务中集成的端口占用检测和处理功能，帮助开发者避免端口冲突问题。

## 功能特性

✅ **自动端口检测**：启动时自动检测端口是否被占用
✅ **自动端口切换**：端口冲突时自动使用下一个可用端口
✅ **友好的错误提示**：提供清晰的错误信息和解决方案
✅ **环境变量支持**：支持通过环境变量自定义端口范围
✅ **多种启动方式**：支持脚本启动和原始启动两种方式

## 使用方法

### 方法一：使用智能启动脚本（推荐）

```bash
# 基本用法（自动检测端口）
pnpm -C apps/api-service run dev:smart

# 或者直接使用脚本
./apps/api-service/scripts/start-dev.sh

# 使用自定义起始端口
PORT_RANGE_START=8000 ./apps/api-service/scripts/start-dev.sh

# 查看帮助信息
./apps/api-service/scripts/start-dev.sh --help
```

### 方法二：环境变量 + 原始启动

```bash
# 设置环境变量后启动
export PORT=8000
pnpm -C apps/api-service dev
```

### 方法三：端口检测工具（独立使用）

```bash
# 检测指定端口范围
node apps/api-service/scripts/port-check.js 7001

# 获取可用端口号（JSON格式）
node apps/api-service/scripts/port-check.js 7001 | grep -A1 "---JSON---"
```

## 启动脚本说明

### start-dev.sh

智能启动脚本，提供以下功能：
- 自动检测端口占用情况
- 端口冲突时自动切换
- 显示端口占用进程信息
- 友好的错误提示和解决方案

**选项：**
- 无参数：使用默认端口 7001，自动检测
- `PORT_RANGE_START=8000`：设置起始端口为 8000

**示例输出：**
```
========================================
  LinglongOS API 服务启动器
========================================

正在检测端口可用性...
检测范围: 7001 - 7050

✓ 找到可用端口: 7002

✓ 端口检测完成
启动端口: 7002

========================================
  启动开发服务器
========================================
```

## 配置文件说明

### config.default.ts

主配置文件已集成端口检测逻辑：

```typescript
const DEFAULT_PORT = parseInt(process.env.PORT || '7001', 10);
const PORT_RANGE = 50;

// 端口检测函数
function isPortAvailable(port: number): Promise<boolean>
async function findAvailablePort(): Promise<number>
```

**环境变量：**
- `PORT`：设置起始端口号（默认：7001）
- `EGG_PORT`：Egg.js 专用端口变量

**配置特性：**
- 检测范围：起始端口 + 50 个端口
- 支持集群模式自动故障转移
- 兼容开发环境和生产环境

## 错误处理

### 常见错误及解决方案

#### 1. 端口全部被占用

**错误信息：**
```
✗ 错误: 无法找到可用端口
检测范围: 7001 - 7050
```

**解决方案：**
```bash
# 1. 关闭占用端口的进程
lsof -ti:7001 | xargs kill -9

# 2. 使用其他端口范围
PORT_RANGE_START=8000 ./apps/api-service/scripts/start-dev.sh

# 3. 查看端口占用情况
lsof -i :7001
netstat -tulpn | grep :7001
```

#### 2. 权限不足

**错误信息：**
```
Error: listen EACCES 0.0.0.0:7001
```

**解决方案：**
```bash
# 使用非特权端口（> 1024）
export PORT=7001
pnpm -C apps/api-service dev

# 或使用 sudo 启动（不推荐）
sudo pnpm -C apps/api-service dev
```

#### 3. 进程僵死

**错误信息：**
```
Error: listen EADDRINUSE 0.0.0.0:7001
```

**解决方案：**
```bash
# 查找并关闭僵死进程
lsof -ti:7001 | xargs kill -9

# 强制杀死进程
kill -9 $(lsof -ti:7001)

# 重启电脑（如果进程无法关闭）
```

## 端口范围说明

### 默认端口范围

- **起始端口**：7001
- **检测范围**：7001 - 7050（50 个端口）
- **适用场景**：开发环境，多实例部署

### 自定义端口范围

```bash
# 设置起始端口
export PORT=8000

# 或者修改配置文件
# 编辑 apps/api-service/config/config.default.ts
# 修改 DEFAULT_PORT 值
```

### 生产环境建议

生产环境建议：
- 使用固定端口，避免自动切换
- 使用反向代理（如 Nginx）进行端口映射
- 部署时明确指定端口号

```bash
# 生产环境启动
PORT=7001 pnpm -C apps/api-service start
```

## 脚本文件位置

```
apps/api-service/
├── scripts/
│   ├── start-dev.sh           # 智能启动脚本
│   ├── dev-with-port-check.sh # 完整版启动脚本
│   └── port-check.js          # 独立端口检测工具
├── config/
│   └── config.default.ts      # 主配置文件（已集成端口检测）
└── docs/
    └── 端口检测工具说明.md    # 本文档
```

## 最佳实践

1. **开发环境**：
   - 使用智能启动脚本 `start-dev.sh`
   - 自动检测端口，避免手动处理冲突

2. **CI/CD 环境**：
   - 使用环境变量 `PORT` 指定端口
   - 结合 Docker 容器使用时特别有用

3. **生产环境**：
   - 固定端口号，避免自动切换
   - 使用负载均衡器或反向代理
   - 监控端口占用情况

4. **多实例部署**：
   - 每个实例使用不同的端口范围
   - 使用服务发现机制管理端口

## 故障排除

### 调试模式

启用详细日志：
```bash
DEBUG=* pnpm -C apps/api-service dev
```

### 手动端口检测

使用系统工具检测端口：
```bash
# macOS/Linux
lsof -i :7001
netstat -tulpn | grep :7001

# Windows
netstat -ano | findstr :7001
```

### 重置所有配置

如果遇到配置问题，可以重置：
```bash
# 清理 node_modules
rm -rf node_modules
pnpm install

# 重置环境变量
unset PORT
unset EGG_PORT
```

## 技术实现

### 端口检测原理

1. **TCP 连接检测**：
   - 创建 TCP 服务器尝试监听端口
   - 如果 `EADDRINUSE` 错误，则端口被占用
   - 如果成功绑定，则端口可用

2. **端口切换算法**：
   - 线性扫描：从起始端口开始逐个检测
   - 最大尝试次数：50 次
   - 返回第一个可用端口

3. **集群支持**：
   - Egg.js 集群模式支持 `strategy: 'failover'`
   - 主进程失败时自动切换到备用进程
   - 适用于高可用部署

### 性能考虑

- **检测速度**：每个端口检测约 100ms
- **内存占用**：最小化，只创建临时连接
- **并发安全**：检测过程是原子的
- **错误恢复**：支持进程重启和异常恢复

## 更新日志

### v1.0.0 (2025-11-06)
- ✅ 初始版本发布
- ✅ 集成端口检测功能
- ✅ 自动端口切换
- ✅ 智能启动脚本
- ✅ 友好错误提示
- ✅ 环境变量支持
- ✅ 集群模式兼容

---

如有问题或建议，请提交 Issue 或 Pull Request。
