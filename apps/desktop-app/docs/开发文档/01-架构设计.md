# 01-æ¶æ„è®¾è®¡

æœ¬æ–‡æ¡£è¯¦ç»†æè¿°äº† Linglong Desktop åº”ç”¨çš„æ•´ä½“æ¶æ„è®¾è®¡ï¼ŒåŒ…æ‹¬ç³»ç»Ÿåˆ†å±‚ã€æ ¸å¿ƒæ¨¡å—ã€çŠ¶æ€ç®¡ç†å’Œæ•°æ®æµè®¾è®¡ã€‚

## ğŸ—ï¸ æ•´ä½“æ¶æ„æ¦‚è§ˆ

Linglong Desktop é‡‡ç”¨åˆ†å±‚æ¶æ„è®¾è®¡ï¼Œéµå¾ªå•ä¸€èŒè´£åŸåˆ™ï¼Œå®ç°æ¸…æ™°çš„åŠŸèƒ½åˆ†ç¦»å’Œæ¨¡å—åŒ–å¼€å‘ã€‚

### æ¶æ„å±‚æ¬¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Presentation Layer                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚   UI Layer  â”‚ â”‚  Event      â”‚ â”‚  Routing        â”‚    â”‚
â”‚  â”‚  Components â”‚ â”‚  Handlers   â”‚ â”‚  & Navigation   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Business Logic Layer                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Feature     â”‚ â”‚  Custom     â”‚ â”‚  Utility        â”‚    â”‚
â”‚  â”‚ Modules     â”‚ â”‚  Hooks      â”‚ â”‚  Functions      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Data Access Layer                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Redux       â”‚ â”‚  Service    â”‚ â”‚  API            â”‚    â”‚
â”‚  â”‚ Store       â”‚ â”‚  Layer      â”‚ â”‚  Communication  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“¦ æ ¸å¿ƒæ¨¡å—

### 1. æ¡Œé¢æ¨¡å— (Desktop Module)

**èŒè´£**: ç®¡ç†æ¡Œé¢ç¯å¢ƒçš„æ ¸å¿ƒåŠŸèƒ½ï¼ŒåŒ…æ‹¬å›¾æ ‡å¸ƒå±€ã€èƒŒæ™¯è®¾ç½®ã€ç½‘æ ¼ç³»ç»Ÿç­‰ã€‚

**ä¸»è¦ç»„ä»¶**:
- `Desktop.tsx` - æ¡Œé¢ä¸»ç»„ä»¶
- `GridSystem` - ç½‘æ ¼å¸ƒå±€ç³»ç»Ÿ
- `IconManager` - å›¾æ ‡ç®¡ç†å™¨
- `BackgroundManager` - èƒŒæ™¯ç®¡ç†å™¨

**çŠ¶æ€ç®¡ç†**:
```typescript
// desktop.slice.ts
interface DesktopState {
  icons: DesktopIcon[];
  widgets: Widget[];
  gridSize: number;
  background: BackgroundConfig;
  selectedItems: Set<string>;
}

interface DesktopIcon {
  id: string;
  name: string;
  icon: string;
  position: { x: number; y: number };
  size: { width: number; height: number };
  isFolder: boolean;
  folderItems?: DesktopIcon[];
}
```

### 2. çª—å£ç®¡ç†æ¨¡å— (Window Management Module)

**èŒè´£**: ç®¡ç†åº”ç”¨çª—å£çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸï¼ŒåŒ…æ‹¬åˆ›å»ºã€æ˜¾ç¤ºã€éšè—ã€å…³é—­ã€æ‹–æ‹½ã€ç¼©æ”¾ç­‰ã€‚

**ä¸»è¦ç»„ä»¶**:
- `WindowManager.tsx` - çª—å£ç®¡ç†å™¨
- `Window.tsx` - å•ä¸ªçª—å£ç»„ä»¶
- `WindowControls.tsx` - çª—å£æ§åˆ¶æŒ‰é’®
- `DockingManager` - åœé ç®¡ç†å™¨

**çŠ¶æ€ç®¡ç†**:
```typescript
// window.slice.ts
interface WindowState {
  windows: WindowInstance[];
  activeWindowId: string | null;
  zIndexCounter: number;
  dockItems: DockItem[];
}

interface WindowInstance {
  id: string;
  appId: string;
  title: string;
  position: { x: number; y: number };
  size: { width: number; height: number };
  isMinimized: boolean;
  isMaximized: boolean;
  isFocused: boolean;
  zIndex: number;
  resizable: boolean;
  closable: boolean;
}
```

### 3. è®¾ç½®æ¨¡å— (Settings Module)

**èŒè´£**: ç®¡ç†åº”ç”¨çš„æ•´ä½“è®¾ç½®ï¼ŒåŒ…æ‹¬ä¸»é¢˜ã€å£çº¸ã€çª—å£é…ç½®ç­‰ã€‚

**ä¸»è¦ç»„ä»¶**:
- `Settings.tsx` - è®¾ç½®ä¸»ç•Œé¢
- `ThemeSettings.tsx` - ä¸»é¢˜è®¾ç½®
- `BackgroundSettings.tsx` - èƒŒæ™¯è®¾ç½®
- `AdminApiSettings.tsx` - API è®¾ç½®

**çŠ¶æ€ç®¡ç†**:
```typescript
// settings.slice.ts
interface SettingsState {
  theme: 'light' | 'dark';
  background: BackgroundSettings;
  dockSettings: DockSettings;
  apiSettings: ApiSettings;
  windowSettings: WindowSettings;
}
```

### 4. åˆå§‹åŒ–æ¨¡å— (Setup Module)

**èŒè´£**: å¤„ç†åº”ç”¨é¦–æ¬¡è¿è¡Œçš„åˆå§‹åŒ–æµç¨‹ï¼ŒåŒ…æ‹¬è®¾ç½®å‘å¯¼ã€æƒé™è¯·æ±‚ç­‰ã€‚

**ä¸»è¦ç»„ä»¶**:
- `Setup.tsx` - åˆå§‹åŒ–ä¸»æµç¨‹
- `SetupView.tsx` - è®¾ç½®æ­¥éª¤è§†å›¾
- `ProgressIndicator` - è¿›åº¦æŒ‡ç¤ºå™¨

**çŠ¶æ€ç®¡ç†**:
```typescript
// setupSlice.ts
interface SetupState {
  currentStep: number;
  totalSteps: number;
  isCompleted: boolean;
  isInProgress: boolean;
  setupData: SetupData;
}

interface SetupData {
  theme: 'light' | 'dark';
  background: string;
  adminApi: {
    host: string;
    apiKey: string;
    isConnected: boolean;
  };
}
```

## ğŸ”„ æ•°æ®æµè®¾è®¡

### 1. å•å‘æ•°æ®æµ

Lingual Desktop éµå¾ª Redux çš„å•å‘æ•°æ®æµæ¨¡å¼ï¼š

```
User Action â†’ Dispatch Action â†’ Update State â†’ Re-render Component â†’ Update View
```

**ç¤ºä¾‹æµç¨‹**:
```typescript
// 1. ç”¨æˆ·ç‚¹å‡»æ¡Œé¢å›¾æ ‡
const handleIconClick = (iconId: string) => {
  // 2. åˆ†å‘action
  dispatch(openWindow({ iconId }));
};

// 3. WindowReducer æ›´æ–°çŠ¶æ€
const windowReducer = createReducer(initialState, (builder) => {
  builder.addCase(openWindow, (state, action) => {
    // 4. åˆ›å»ºæ–°çª—å£å®ä¾‹
    const newWindow = createWindowInstance(action.payload.iconId);
    state.windows.push(newWindow);
  });
});

// 5. ç»„ä»¶é‡æ–°æ¸²æŸ“
const WindowManager = () => {
  const windows = useSelector(state => state.window.windows);
  // 6. æ¸²æŸ“çª—å£
  return windows.map(window => <Window key={window.id} {...window} />);
};
```

### 2. äº‹ä»¶å¤„ç†æµç¨‹

**æ‹–æ‹½äº‹ä»¶æµç¨‹**:
```
MouseDown â†’ StartDrag â†’ useDrag â†’ Drag â†’ useDrop â†’ Drop â†’ UpdatePosition
```

```typescript
// æ‹–æ‹½å¼€å§‹çš„ Hook
const useDesktopIconDrag = () => {
  const dispatch = useAppDispatch();
  
  const dragHandlers = useDrag({
    type: 'desktop-icon',
    item: { id, originalPosition },
    collect: (monitor) => ({
      isDragging: monitor.isDragging(),
    }),
    end: (item, monitor) => {
      if (!monitor.didDrop()) {
        // æ‹–æ‹½è¢«å–æ¶ˆï¼Œæ¢å¤åŸä½ç½®
        dispatch(revertIconPosition({ id: item.id }));
      } else {
        // æ‹–æ‹½å®Œæˆï¼Œæ›´æ–°ä½ç½®
        const delta = monitor.getDifferenceFromInitialOffset();
        const newPosition = calculateNewPosition(
          item.originalPosition,
          delta
        );
        dispatch(updateIconPosition({ id: item.id, position: newPosition }));
      }
    },
  });
  
  return dragHandlers;
};
```

## ğŸ”Œ æœåŠ¡å±‚æ¶æ„

### 1. API æœåŠ¡

**èŒè´£**: ç»Ÿä¸€ç®¡ç†ä¸åç«¯ API çš„é€šä¿¡ï¼ŒåŒ…æ‹¬è®¤è¯ã€æ•°æ®åŒæ­¥ç­‰ã€‚

**æ ¸å¿ƒæœåŠ¡**:
```typescript
// api.service.ts
class ApiService {
  private baseURL: string;
  private authToken: string | null = null;

  constructor() {
    this.baseURL = import.meta.env.VITE_API_BASE_URL || 'http://localhost:4000';
    this.loadAuthToken();
  }

  async authenticate(credentials: AuthCredentials): Promise<AuthResponse> {
    const response = await this.post('/auth/login', credentials);
    this.setAuthToken(response.token);
    return response;
  }

  async syncDesktopState(desktopState: DesktopState): Promise<void> {
    return this.post('/desktop/sync', desktopState);
  }

  async getWindowSettings(): Promise<WindowSettings> {
    return this.get('/settings/windows');
  }

  private async request<T>(
    endpoint: string,
    options: RequestInit = {}
  ): Promise<T> {
    const config = {
      headers: {
        'Authorization': `Bearer ${this.authToken}`,
        'Content-Type': 'application/json',
        ...options.headers,
      },
      ...options,
    };

    try {
      const response = await fetch(`${this.baseURL}${endpoint}`, config);
      
      if (!response.ok) {
        throw new ApiError(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      return await response.json();
    } catch (error) {
      console.error('APIè¯·æ±‚å¤±è´¥:', error);
      throw error;
    }
  }
}
```

### 2. é…ç½®æœåŠ¡

**èŒè´£**: ç®¡ç†åº”ç”¨é…ç½®ä¿¡æ¯çš„è¯»å–ã€å†™å…¥å’ŒéªŒè¯ã€‚

```typescript
// config.service.ts
class ConfigService {
  private config: AppConfig = {
    desktop: {
      gridSize: 64,
      iconSize: 48,
      defaultBackground: 'default-wallpaper.jpg',
    },
    window: {
      defaultSize: { width: 800, height: 600 },
      minSize: { width: 400, height: 300 },
      animations: true,
    },
    theme: {
      primaryColor: '#3b82f6',
      darkMode: false,
    },
  };

  async loadConfig(): Promise<AppConfig> {
    try {
      const localConfig = localStorage.getItem('desktop-config');
      if (localConfig) {
        this.config = { ...this.config, ...JSON.parse(localConfig) };
      }
    } catch (error) {
      console.warn('åŠ è½½é…ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é…ç½®:', error);
    }
    return this.config;
  }

  async saveConfig(updates: Partial<AppConfig>): Promise<void> {
    this.config = { ...this.config, ...updates };
    localStorage.setItem('desktop-config', JSON.stringify(this.config));
    
    // åŒæ­¥åˆ°äº‘ç«¯
    await this.apiService.syncConfig(this.config);
  }

  getConfig(): AppConfig {
    return { ...this.config };
  }
}
```

## ğŸ¨ è®¾è®¡æ¨¡å¼

### 1. ç»„åˆæ¨¡å¼ (Composite Pattern)

ç”¨äºå¤„ç†çª—å£å’Œç»„ä»¶çš„å±‚æ¬¡ç»“æ„ï¼š

```typescript
// ç»„åˆæ¨¡å¼ç¤ºä¾‹ - çª—å£å†…å®¹ç»„ä»¶
interface WindowContent {
  render(): React.ReactNode;
}

class BaseWindowContent implements WindowContent {
  constructor(protected children: WindowContent[] = []) {}
  
  render(): React.ReactNode {
    return this.children.map(child => child.render());
  }
}

class IconContainer extends BaseWindowContent {
  render(): React.ReactNode {
    return (
      <div className="icon-container">
        {super.render()}
      </div>
    );
  }
}
```

### 2. è§‚å¯Ÿè€…æ¨¡å¼ (Observer Pattern)

ç”¨äºäº‹ä»¶ç®¡ç†å’ŒçŠ¶æ€ç›‘å¬ï¼š

```typescript
// äº‹ä»¶ç³»ç»Ÿ
class EventManager {
  private events: Map<string, Set<Function>> = new Map();

  on(event: string, callback: Function): void {
    if (!this.events.has(event)) {
      this.events.set(event, new Set());
    }
    this.events.get(event)!.add(callback);
  }

  off(event: string, callback: Function): void {
    const callbacks = this.events.get(event);
    if (callbacks) {
      callbacks.delete(callback);
    }
  }

  emit(event: string, ...args: any[]): void {
    const callbacks = this.events.get(event);
    if (callbacks) {
      callbacks.forEach(callback => callback(...args));
    }
  }
}

export const eventManager = new EventManager();

// ä½¿ç”¨ç¤ºä¾‹
eventManager.on('window:closed', (windowId: string) => {
  console.log(`çª—å£ ${windowId} å·²å…³é—­`);
});

eventManager.emit('window:closed', 'window-123');
```

### 3. ç­–ç•¥æ¨¡å¼ (Strategy Pattern)

ç”¨äºä¸»é¢˜åˆ‡æ¢å’ŒèƒŒæ™¯ç®¡ç†ï¼š

```typescript
// ä¸»é¢˜ç­–ç•¥æ¥å£
interface ThemeStrategy {
  getColors(): ThemeColors;
  applyTheme(element: HTMLElement): void;
}

class LightThemeStrategy implements ThemeStrategy {
  getColors(): ThemeColors {
    return {
      primary: '#3b82f6',
      background: '#ffffff',
      surface: '#f8fafc',
      text: '#1f2937',
      border: '#e5e7eb',
    };
  }

  applyTheme(element: HTMLElement): void {
    const colors = this.getColors();
    element.style.setProperty('--color-primary', colors.primary);
    element.style.setProperty('--color-bg', colors.background);
    element.style.setProperty('--color-surface', colors.surface);
  }
}

class DarkThemeStrategy implements ThemeStrategy {
  getColors(): ThemeColors {
    return {
      primary: '#60a5fa',
      background: '#111827',
      surface: '#1f2937',
      text: '#f9fafb',
      border: '#374151',
    };
  }

  applyTheme(element: HTMLElement): void {
    const colors = this.getColors();
    element.style.setProperty('--color-primary', colors.primary);
    element.style.setProperty('--color-bg', colors.background);
    element.style.setProperty('--color-surface', colors.surface);
  }
}

class ThemeManager {
  private currentStrategy: ThemeStrategy;

  constructor() {
    this.currentStrategy = new LightThemeStrategy();
  }

  setTheme(theme: 'light' | 'dark'): void {
    this.currentStrategy = theme === 'light' 
      ? new LightThemeStrategy()
      : new DarkThemeStrategy();
    
    this.applyTheme();
  }

  applyTheme(): void {
    const htmlElement = document.documentElement;
    this.currentStrategy.applyTheme(htmlElement);
  }

  getColors(): ThemeColors {
    return this.currentStrategy.getColors();
  }
}
```

## ğŸš€ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 1. è™šæ‹ŸåŒ–

å¯¹äºå¤§é‡å›¾æ ‡çš„æ¡Œé¢ï¼Œè™šæ‹ŸåŒ–æ˜¯å¿…è¦çš„ï¼š

```typescript
// è™šæ‹ŸåŒ–åˆ—è¡¨ç»„ä»¶
const VirtualizedIconGrid: React.FC<VirtualizedIconGridProps> = ({
  icons,
  containerSize,
  iconSize,
  gridSize,
}) => {
  const { scrollTop } = useScrollPosition();
  
  const visibleRange = useMemo(() => {
    const startIndex = Math.floor(scrollTop / (iconSize + gridSize));
    const endIndex = Math.min(
      startIndex + Math.ceil(containerSize.height / (iconSize + gridSize)) + 1,
      icons.length
    );
    return { start: startIndex, end: endIndex };
  }, [scrollTop, containerSize, iconSize, gridSize, icons.length]);

  const visibleIcons = useMemo(
    () => icons.slice(visibleRange.start, visibleRange.end),
    [icons, visibleRange]
  );

  return (
    <div style={{ height: containerSize.height }}>
      <div style={{ height: visibleRange.start * (iconSize + gridSize) }} />
      {visibleIcons.map((icon, index) => (
        <div
          key={icon.id}
          style={{
            height: iconSize,
            marginBottom: gridSize,
            transform: `translateY(${(visibleRange.start + index) * (iconSize + gridSize)}px)`,
          }}
        >
          <DesktopIcon {...icon} />
        </div>
      ))}
    </div>
  );
};
```

### 2. ç»„ä»¶ä¼˜åŒ–

```typescript
// ä½¿ç”¨ React.memo ä¼˜åŒ–ç»„ä»¶
const Window = React.memo<WindowProps>(({ window, onMove, onResize, onClose }) => {
  return (
    <div
      className="window"
      style={{
        position: 'absolute',
        left: window.position.x,
        top: window.position.y,
        width: window.size.width,
        height: window.size.height,
        zIndex: window.zIndex,
      }}
    >
      <WindowTitle
        title={window.title}
        onMove={onMove}
        onClose={onClose}
      />
      <WindowContent appId={window.appId} />
      <WindowResizeHandles onResize={onResize} />
    </div>
  );
});

// ä½¿ç”¨ useMemo ä¼˜åŒ–è®¡ç®—
const OptimizedIcon = ({ icon }: { icon: DesktopIcon }) => {
  const { gridPosition } = useMemo(() => {
    return {
      gridPosition: calculateGridPosition(icon.position),
    };
  }, [icon.position]);

  return <DesktopIcon icon={icon} gridPosition={gridPosition} />;
};
```

### 3. çŠ¶æ€ä¼˜åŒ–

```typescript
// ä½¿ç”¨ Reselect è¿›è¡ŒçŠ¶æ€é€‰æ‹©å™¨ä¼˜åŒ–
import { createSelector, createFeatureSelector } from '@reduxjs/toolkit';

const selectWindowState = createFeatureSelector<WindowState>('window');

const selectActiveWindow = createSelector(
  selectWindowState,
  (windowState) => windowState.windows.find(
    window => window.id === windowState.activeWindowId
  )
);

const selectVisibleWindows = createSelector(
  selectWindowState,
  (windowState) => windowState.windows.filter(
    window => !window.isMinimized
  )
);
```

## ğŸ”§ å¯æ‰©å±•æ€§è®¾è®¡

### 1. æ’ä»¶ç³»ç»Ÿæ¶æ„

```typescript
// æ’ä»¶æ¥å£å®šä¹‰
interface DesktopPlugin {
  id: string;
  name: string;
  version: string;
  author: string;
  onLoad?: (api: PluginAPI) => void;
  onUnload?: () => void;
}

interface PluginAPI {
  registerWidget: (widget: WidgetConfig) => void;
  registerStatusIcon: (icon: StatusIconConfig) => void;
  registerContextMenu: (menu: ContextMenuConfig) => void;
  getDesktopState: () => DesktopState;
  updateDesktopState: (updates: Partial<DesktopState>) => void;
  showNotification: (notification: NotificationConfig) => void;
}

// æ’ä»¶ç®¡ç†å™¨
class PluginManager {
  private plugins: Map<string, DesktopPlugin> = new Map();
  private pluginAPI: PluginAPI;

  constructor() {
    this.pluginAPI = this.createPluginAPI();
  }

  loadPlugin(plugin: DesktopPlugin): void {
    if (this.plugins.has(plugin.id)) {
      console.warn(`æ’ä»¶ ${plugin.id} å·²å­˜åœ¨ï¼Œè·³è¿‡åŠ è½½`);
      return;
    }

    this.plugins.set(plugin.id, plugin);
    
    try {
      if (plugin.onLoad) {
        plugin.onLoad(this.pluginAPI);
      }
      console.log(`æ’ä»¶ ${plugin.name} åŠ è½½æˆåŠŸ`);
    } catch (error) {
      console.error(`æ’ä»¶ ${plugin.name} åŠ è½½å¤±è´¥:`, error);
      this.plugins.delete(plugin.id);
    }
  }

  unloadPlugin(pluginId: string): void {
    const plugin = this.plugins.get(pluginId);
    if (!plugin) {
      console.warn(`æ’ä»¶ ${pluginId} ä¸å­˜åœ¨`);
      return;
    }

    try {
      if (plugin.onUnload) {
        plugin.onUnload();
      }
      this.plugins.delete(pluginId);
      console.log(`æ’ä»¶ ${plugin.name} å¸è½½æˆåŠŸ`);
    } catch (error) {
      console.error(`æ’ä»¶ ${plugin.name} å¸è½½å¤±è´¥:`, error);
    }
  }

  private createPluginAPI(): PluginAPI {
    return {
      registerWidget: (widget) => {
        eventManager.emit('plugin:registerWidget', widget);
      },
      registerStatusIcon: (icon) => {
        eventManager.emit('plugin:registerStatusIcon', icon);
      },
      registerContextMenu: (menu) => {
        eventManager.emit('plugin:registerContextMenu', menu);
      },
      getDesktopState: () => {
        return store.getState().desktop;
      },
      updateDesktopState: (updates) => {
        store.dispatch(updateDesktopState(updates));
      },
      showNotification: (notification) => {
        eventManager.emit('ui:showNotification', notification);
      },
    };
  }
}

export const pluginManager = new PluginManager();
```

### 2. ä¸»é¢˜æ‰©å±•

```typescript
// ä¸»é¢˜åŒ…æ¥å£
interface ThemePackage {
  id: string;
  name: string;
  version: string;
  colors: ThemeColors;
  fonts: ThemeFonts;
  animations: ThemeAnimations;
  assets: ThemeAssets;
}

// ä¸»é¢˜åŒ…ç®¡ç†å™¨
class ThemeManager {
  private themes: Map<string, ThemePackage> = new Map();
  private currentTheme: string = 'default';

  installTheme(theme: ThemePackage): void {
    this.themes.set(theme.id, theme);
    console.log(`ä¸»é¢˜ ${theme.name} å®‰è£…æˆåŠŸ`);
  }

  switchTheme(themeId: string): void {
    const theme = this.themes.get(themeId);
    if (!theme) {
      console.error(`ä¸»é¢˜ ${themeId} ä¸å­˜åœ¨`);
      return;
    }

    this.currentTheme = themeId;
    this.applyTheme(theme);
    this.saveUserPreferences();
    
    eventManager.emit('theme:changed', theme);
  }

  private applyTheme(theme: ThemePackage): void {
    const root = document.documentElement;
    
    // åº”ç”¨é¢œè‰²å˜é‡
    Object.entries(theme.colors).forEach(([key, value]) => {
      root.style.setProperty(`--theme-${key}`, value);
    });

    // åº”ç”¨å­—ä½“
    if (theme.fonts.primary) {
      root.style.setProperty('--font-primary', theme.fonts.primary);
    }

    // é¢„åŠ è½½èµ„æº
    this.preloadAssets(theme.assets);
  }
}
```

## ğŸ“Š ç›‘æ§å’Œè°ƒè¯•

### 1. æ€§èƒ½ç›‘æ§

```typescript
// æ€§èƒ½ç›‘æ§å·¥å…·
class PerformanceMonitor {
  private metrics: Map<string, PerformanceMetric[]> = new Map();

  startTiming(label: string): string {
    const timerId = `${label}-${Date.now()}`;
    performance.mark(`${timerId}-start`);
    return timerId;
  }

  endTiming(timerId: string, label: string): void {
    performance.mark(`${timerId}-end`);
    performance.measure(label, `${timerId}-start`, `${timerId}-end`);

    const measure = performance.getEntriesByName(label, 'measure')[0];
    this.recordMetric(label, {
      duration: measure.duration,
      timestamp: Date.now(),
    });
  }

  private recordMetric(label: string, metric: PerformanceMetric): void {
    if (!this.metrics.has(label)) {
      this.metrics.set(label, []);
    }
    
    const metrics = this.metrics.get(label)!;
    metrics.push(metric);
    
    // ä¿æŒæœ€è¿‘100ä¸ªæŒ‡æ ‡
    if (metrics.length > 100) {
      metrics.shift();
    }
  }

  getMetrics(label: string): PerformanceMetric[] {
    return this.metrics.get(label) || [];
  }

  getAverageDuration(label: string): number {
    const metrics = this.getMetrics(label);
    if (metrics.length === 0) return 0;
    
    const total = metrics.reduce((sum, metric) => sum + metric.duration, 0);
    return total / metrics.length;
  }
}

export const performanceMonitor = new PerformanceMonitor();
```

### 2. è°ƒè¯•å·¥å…·

```typescript
// è°ƒè¯•å·¥å…·é›†
class DebugTools {
  static enableDevTools(): void {
    if (process.env.NODE_ENV !== 'development') return;

    // æ³¨å…¥è°ƒè¯•çª—å£
    const debugPanel = document.createElement('div');
    debugPanel.id = 'desktop-debug-panel';
    debugPanel.innerHTML = `
      <div style="position: fixed; top: 10px; right: 10px; 
                  background: rgba(0,0,0,0.8); color: white; 
                  padding: 10px; border-radius: 5px; z-index: 9999;
                  font-family: monospace; font-size: 12px;">
        <h4>Desktop Debug</h4>
        <div id="debug-windows">Windows: 0</div>
        <div id="debug-performance">Performance: 0ms</div>
        <button onclick="window.__desktopDebug.clearAllWindows()">Clear Windows</button>
        <button onclick="window.__desktopDebug.toggleDevTools()">DevTools</button>
      </div>
    `;
    document.body.appendChild(debugPanel);

    // æš´éœ²è°ƒè¯•API
    (window as any).__desktopDebug = {
      clearAllWindows: () => {
        store.dispatch(clearAllWindows());
      },
      toggleDevTools: () => {
        // è§¦å‘å¼€å‘å·¥å…·
        console.log('åˆ‡æ¢å¼€å‘å·¥å…·');
      },
      getState: () => store.getState(),
      dispatch: (action: any) => store.dispatch(action),
    };

    // çŠ¶æ€å˜åŒ–ç›‘å¬
    store.subscribe(() => {
      const state = store.getState();
      const windowsElement = document.getElementById('debug-windows');
      if (windowsElement) {
        windowsElement.textContent = `Windows: ${state.window.windows.length}`;
      }
    });
  }
}

// è‡ªåŠ¨å¯ç”¨è°ƒè¯•å·¥å…·
DebugTools.enableDevTools();
```

## ğŸ¯ æ€»ç»“

Linglong Desktop çš„æ¶æ„è®¾è®¡å……åˆ†è€ƒè™‘äº†ç°ä»£Webåº”ç”¨çš„éœ€æ±‚ï¼š

1. **åˆ†å±‚æ¸…æ™°**: æ˜ç¡®åˆ†ç¦»è¡¨ç¤ºå±‚ã€ä¸šåŠ¡é€»è¾‘å±‚å’Œæ•°æ®è®¿é—®å±‚
2. **æ¨¡å—åŒ–**: æ¯ä¸ªåŠŸèƒ½æ¨¡å—ç‹¬ç«‹å¼€å‘å’Œæµ‹è¯•
3. **å¯æ‰©å±•æ€§**: æ’ä»¶ç³»ç»Ÿå’Œä¸»é¢˜ç³»ç»Ÿæ”¯æŒæ— é™æ‰©å±•
4. **æ€§èƒ½ä¼˜åŒ–**: è™šæ‹ŸåŒ–ã€ç»„ä»¶ä¼˜åŒ–ã€çŠ¶æ€ä¼˜åŒ–ç¡®ä¿æµç•…ä½“éªŒ
5. **å¼€å‘å‹å¥½**: å®Œå–„çš„è°ƒè¯•å·¥å…·å’Œæ€§èƒ½ç›‘æ§

è¿™ç§æ¶æ„ç¡®ä¿äº†åº”ç”¨èƒ½å¤Ÿéšç€åŠŸèƒ½éœ€æ±‚çš„å˜åŒ–è€Œçµæ´»æ¼”è¿›ï¼ŒåŒæ—¶ä¿æŒé«˜æ€§èƒ½å’Œè‰¯å¥½çš„ç”¨æˆ·ä½“éªŒã€‚

---

*æ›´å¤šè¯¦ç»†ä¿¡æ¯è¯·å‚è€ƒå…¶ä»–å¼€å‘æ–‡æ¡£æˆ–æºä»£ç æ³¨é‡Šã€‚*